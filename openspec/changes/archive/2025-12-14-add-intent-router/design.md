# 架构设计：智能意图路由

## 1. 系统架构

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (Browser)                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  翻译方向选择                                              │   │
│  │  ○ 智能识别 (auto)  ○ 产品→开发  ○ 开发→产品              │   │
│  └─────────────────────────────────────────────────────────┘   │
└──────────────────────────┬──────────────────────────────────────┘
                           │ POST /api/translate
                           │ { content, direction?, auto_detect }
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      后端 API (FastAPI)                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    /api/translate                         │   │
│  │  1. 检查 direction 是否指定                                │   │
│  │  2. 若 auto_detect=true → 调用意图路由器                   │   │
│  │  3. 调用对应翻译 Agent                                     │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                      │
│  ┌────────────────────────▼────────────────────────────────┐   │
│  │              IntentRouter (意图路由器)                     │   │
│  │  - 分析输入内容                                            │   │
│  │  - 判断: product_to_dev / dev_to_product                  │   │
│  │  - 返回: direction + confidence                           │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                      │
│           ┌───────────────┴───────────────┐                     │
│           ▼                               ▼                     │
│  ┌─────────────────┐             ┌─────────────────┐           │
│  │  ProductToDevAgent│             │  DevToProductAgent│           │
│  │  (产品→开发翻译)   │             │  (开发→产品翻译)   │           │
│  └─────────────────┘             └─────────────────┘           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 处理流程

```
┌─────────────┐    ┌──────────────┐    ┌─────────────┐    ┌─────────────┐
│  用户输入   │───▶│  意图识别    │───▶│  路由决策   │───▶│  翻译输出   │
│             │    │  Agent       │    │             │    │  Agent      │
└─────────────┘    └──────────────┘    └─────────────┘    └─────────────┘
      │                  │                   │                   │
      │                  ▼                   ▼                   ▼
      │           识别结果:            选择翻译方向:         执行翻译:
      │           - direction         - product_to_dev      - 流式输出
      │           - confidence        - dev_to_product      - SSE 响应
      │           - reasoning         - 低置信度提示
      │
      └─── direction 已指定 ──────────────────────────────────────▶
           (跳过意图识别，直接翻译)
```

## 2. 组件设计

### 2.1 IntentRouter 意图路由器

**职责**：分析用户输入，判断其属于「产品需求描述」还是「技术方案描述」

**输入**：
```python
class IntentRequest(BaseModel):
    content: str  # 用户输入的原始内容
```

**输出**：
```python
class IntentResult(BaseModel):
    direction: TranslationDirection  # 识别出的翻译方向
    confidence: float                # 置信度 (0.0 - 1.0)
    reasoning: str                   # 判断依据（用于调试）
```

**识别规则**：

| 特征 | 产品需求 (product_to_dev) | 技术方案 (dev_to_product) |
|-----|-------------------------|-------------------------|
| 关键词 | 用户、需求、功能、体验、转化率 | API、数据库、算法、优化、重构 |
| 描述风格 | 目标导向、业务场景、用户故事 | 实现细节、性能指标、技术术语 |
| 问题类型 | "我们想要..."、"用户需要..." | "我们实现了..."、"性能提升..." |

### 2.2 意图识别 Prompt 设计

```python
INTENT_ROUTER_PROMPT = """你是一个内容分类专家，负责判断用户输入的内容类型。

请分析以下内容，判断它是：
1. **产品需求描述** (product_to_dev) - 来自产品经理的业务需求、功能描述、用户故事
2. **技术方案描述** (dev_to_product) - 来自开发工程师的技术实现、架构设计、性能优化

判断依据：
- 产品需求特征：关注用户体验、业务目标、功能期望、使用场景
- 技术方案特征：涉及具体实现、技术术语、性能指标、代码/架构

请以 JSON 格式返回结果：
{
  "direction": "product_to_dev" 或 "dev_to_product",
  "confidence": 0.0-1.0 的置信度分数,
  "reasoning": "简要说明判断依据"
}

仅返回 JSON，不要其他内容。
"""
```

### 2.3 置信度处理策略

| 置信度范围 | 行为 |
|-----------|------|
| ≥ 0.8 | 直接执行翻译 |
| 0.5 - 0.8 | 执行翻译，但在结果前提示"系统自动识别，如有误请手动选择" |
| < 0.5 | 返回提示，建议用户手动选择翻译方向 |

## 3. API 设计

### 3.1 请求模型变更

```python
class TranslateRequest(BaseModel):
    content: str = Field(
        ...,
        min_length=10,
        max_length=2000,
        description="待翻译的原始内容"
    )
    direction: Optional[TranslationDirection] = Field(
        None,
        description="翻译方向，为空时根据 auto_detect 决定行为"
    )
    auto_detect: bool = Field(
        False,
        description="是否启用智能意图识别"
    )
```

### 3.2 响应格式

智能模式下，响应头部增加识别信息：
```
data: [META] {"detected_direction": "product_to_dev", "confidence": 0.92}

data: ## 技术实现建议
...
data: [DONE]
```

### 3.3 接口行为矩阵

| direction | auto_detect | 行为 |
|-----------|-------------|------|
| 指定值 | false | 直接按指定方向翻译 |
| 指定值 | true | 忽略 auto_detect，按指定方向翻译 |
| None | false | 返回 400 错误，提示需要指定方向 |
| None | true | 启用智能意图识别，自动选择方向 |

## 4. 性能考量

### 4.1 延迟优化

- 意图识别使用简短 prompt，预计响应时间 < 500ms
- 意图识别不使用流式输出，直接返回 JSON
- 使用相同的 LLM 模型，无需额外服务

### 4.2 成本控制

- 意图识别 prompt 约 200 tokens
- 输入内容 max 2000 字符 ≈ 800 tokens
- 输出约 50 tokens
- 单次意图识别成本约为翻译成本的 5-10%

## 5. 模块关系

```
src/
├── config.py          # 配置（无变更）
├── models.py          # 数据模型（修改 TranslateRequest）
├── prompts.py         # 提示词（新增 INTENT_ROUTER_PROMPT）
├── router.py          # 意图路由器（新增）
├── translator.py      # 翻译器（无变更）
└── main.py            # API 接口（修改 /api/translate）

static/
├── index.html         # 前端页面（新增智能模式选项）
├── style.css          # 样式（可能微调）
└── app.js             # 前端逻辑（支持智能模式）
```

## 6. 技术决策记录

### 6.1 为何使用 LLM 而非规则匹配？

**考虑的方案**：
1. 关键词匹配 + 规则引擎
2. 传统 NLP 分类模型
3. LLM 意图识别

**选择 LLM 的原因**：
- 无需训练数据和模型维护
- 对混合内容、模糊表述有更好的理解能力
- 与现有翻译 Agent 共用同一 LLM 服务，架构一致
- 开发成本低，可快速迭代优化 prompt

### 6.2 为何保留手动模式？

- 用户可能有明确意图，不希望被系统"猜测"
- 低置信度场景下的降级方案
- 兼容现有 API 调用方（向后兼容）
